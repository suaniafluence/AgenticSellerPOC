name: CI

on:
  push:
    branches: [ main, 'claude/**' ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.9', '3.10', '3.11']

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}

    - name: Cache pip packages
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Verify Python syntax
      run: |
        python -m py_compile main.py orchestrator.py config.py memory.py state.py examples.py run_web.py
        for file in agents/*.py; do
          python -m py_compile "$file"
        done
        for file in web/*.py; do
          python -m py_compile "$file"
        done
        for file in tests/*.py; do
          python -m py_compile "$file"
        done

    - name: Create test directories
      run: |
        mkdir -p ./data
        mkdir -p ./test_data

    - name: Run unit tests
      env:
        TESTING: "true"
        SECRET_KEY: "test-secret-key-ci"
        GOOGLE_CLIENT_ID: "test-client-id"
        GOOGLE_CLIENT_SECRET: "test-client-secret"
        APP_URL: "http://localhost:8000"
        AUTHORIZED_EMAILS: "test@example.com"
        DATABASE_URL: "sqlite+aiosqlite:///./test_data/test.db"
        OPENAI_API_KEY: "test-key"
        ANTHROPIC_API_KEY: "test-key"
      run: |
        pytest tests/ -v --ignore=tests/test_e2e.py --tb=short -x

    - name: Run application help
      run: |
        python main.py --help || true

  lint:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install linting tools
      run: |
        python -m pip install --upgrade pip
        pip install flake8 black isort

    - name: Run flake8
      run: |
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics --exclude=.git,__pycache__,web/templates

    - name: Check code formatting with black
      run: |
        black --check . --exclude="web/templates" || true

    - name: Check import sorting with isort
      run: |
        isort --check-only . --skip web/templates || true

  e2e:
    runs-on: ubuntu-latest
    needs: test

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        playwright install chromium

    - name: Create test directories
      run: |
        mkdir -p ./data
        mkdir -p ./test_data

    - name: Run E2E tests
      env:
        TESTING: "true"
        SECRET_KEY: "e2e-test-secret-key"
        GOOGLE_CLIENT_ID: "test-client-id"
        GOOGLE_CLIENT_SECRET: "test-client-secret"
        APP_URL: "http://localhost:8765"
        AUTHORIZED_EMAILS: "e2e-test@example.com"
        DATABASE_URL: "sqlite+aiosqlite:///./test_data/e2e.db"
        OPENAI_API_KEY: "test-key"
        ANTHROPIC_API_KEY: "test-key"
      run: |
        pytest tests/test_e2e.py -v --tb=short -m e2e || true
